<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title></title>
    <meta charset="utf-8" />
    <script src="JavaScript.js"></script>
</head>
<body>
    資料來源：
    <select id="ddlDataSource">
        <option selected="selected">請選擇</option>
    </select>
    <br />
    欄位：
    <table id="tdDataColumns">
        <tbody></tbody>
    </table>
    <br />
    <input type="button" id="btnPreview" value="預覽" />

    <div id="dialog2">
    </div>
</body>
</html>
<script type="text/javascript">
    $(document).ready(function () {
        var dataSourceResult;
        var ddlDataSourceVal;

        //取得資料來源
        //$.ajax({
        //    url: "../Handler2.ashx",
        //    data:{
        //        'Get':'dataSource'
        //    },
        //    context: JSON,
        //    error: function (xhr) { alert("error:" + xhr) },
        //    success: function (response) {
        //        dataSourceResult = response;
        //        for (var i = 0; i < response.length; i++) {
        //            $("#ddlDataSource").append('<option value=' + response[i]["TableName"] + '>' + response[i]["TableName"] + '</option>');
        //        }
        //    }
        //});
        var sUrl = "../Handler2.ashx";
        var sData = { 'Get': 'dataSource' };
        var sContext = "JSON";
        function successFun(response) {
            dataSourceResult = response;
            for (var i = 0; i < response.length; i++) {
                $("#ddlDataSource").append('<option value=' + response[i]["TableName"] + '>' + response[i]["TableName"] + '</option>');
            }
        }
        callAjax(sUrl, sData, sContext, successFun);


        //資料來源切換
        $('#ddlDataSource').on('change', function () {
            ddlDataSourceVal = $(this).val();
            $("#tdDataColumns tbody tr").detach();
            for (var i = 0; i < dataSourceResult.length; i++) {
                if (dataSourceResult[i]["TableName"] == ddlDataSourceVal) {
                    for (var j = 0; j < dataSourceResult[i]["Fields"].length; j++) {
                        $("#tdDataColumns tbody").append('<tr><td><input type="checkbox"></td><td>' + dataSourceResult[i]["Fields"][j] + '</td></tr>')
                    }
                }
            }
        });

        //預覽
        $('#btnPreview').on('click', function () {
            //$.ajax({
            //    url: "../Handler2.ashx",
            //    data: {
            //        'Get': 'preview',
            //        'DataSource': ddlDataSourceVal
            //    },
            //    context: JSON,
            //    error: function (xhr) { alert("error:" + xhr) },
            //    success: function (response) {
            //        $("#dialog2").html("");

            //        var tr = "";
            //        for (var i = 0; i < response.length; i++) {
            //            tr += '<tr><td>' + response[i]["Value1"] + '</td><td>' + response[i]["Value2"] + '</td><td>' + response[i]["Value3"] + '</td><td>' + response[i]["Value4"] + '</td></tr>';
            //        }

            //        $("#dialog2").append("<table border='1' width='400px'>" + tr + "</table>");
            //        $("#dialog2").dialog("open");
            //    }
            //});

            var sUrl = "../Handler2.ashx";
            var sData = {
                'Get': 'preview',
                'DataSource': ddlDataSourceVal
            };
            var sContext = "JSON";
            function successFun(response) {
                $("#dialog2").html("");

                var tr = "";
                for (var i = 0; i < response.length; i++) {
                    tr += '<tr><td>' + response[i]["Value1"] + '</td><td>' + response[i]["Value2"] + '</td><td>' + response[i]["Value3"] + '</td><td>' + response[i]["Value4"] + '</td></tr>';
                }

                $("#dialog2").append("<table border='1' width='400px'>" + tr + "</table>");
                $("#dialog2").dialog("open");
            }
            callAjax(sUrl, sData, sContext, successFun);
        });
    });


    $(function () {
        $("#dialog2").dialog({
            autoOpen: false,
            height: 450,
            width: 500,
            modal: true,
            buttons: {
                Cancel: function () {
                    $(this).dialog("close");
                }
            }
        });
    });
</script>
